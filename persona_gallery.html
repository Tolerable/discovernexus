<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Gallery - NEXUS</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#00d4ff">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            padding-top: 70px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .header {
            padding: 20px 40px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .gems-display {
            background: rgba(255,215,0,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid gold;
            color: gold;
        }

        .header-nav {
            display: flex;
            gap: 15px;
        }

        .header-nav a {
            color: #fff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .store-link {
            background: linear-gradient(90deg, #e94560, #7b2cbf);
            border: 1px solid #e94560;
        }

        .store-link:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.5);
        }

        .nav-link {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .nav-link:hover {
            background: rgba(123,44,191,0.3);
            border-color: #7b2cbf;
        }

        .promo-banner {
            background: linear-gradient(90deg, rgba(233,69,96,0.2), rgba(123,44,191,0.2));
            padding: 12px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .promo-banner a {
            color: #00d4ff;
            text-decoration: none;
        }

        .promo-banner a:hover {
            text-decoration: underline;
        }


        /* Frame Selector */
        .frame-selector {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 16px;
            padding: 15px;
            width: 200px;
            z-index: 500;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .frame-selector h4 {
            color: #d4af37;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        .frame-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
        }

        .frame-none { background: rgba(255,255,255,0.1); border: 2px dashed rgba(255,255,255,0.3); }
        .frame-ruby { background: linear-gradient(135deg, #e74c3c, #c0392b); box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        .frame-diamond { background: linear-gradient(135deg, #ecf0f1, #bdc3c7); box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .frame-emerald { background: linear-gradient(135deg, #2ecc71, #27ae60); box-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
        .frame-sapphire { background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 0 20px rgba(52, 152, 219, 0.5); }
        .frame-cosmic { background: linear-gradient(135deg, #9b59b6, #1a1a2e, #00d4ff); box-shadow: 0 0 25px rgba(155, 89, 182, 0.6); }
        .frame-mythic { background: linear-gradient(45deg, #f39c12, #e74c3c, #9b59b6, #3498db); background-size: 300% 300%; animation: mythicShift 3s ease infinite; }

        @keyframes mythicShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .frame-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .frame-nav button {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.4);
            color: #00d4ff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .frame-nav button:hover {
            background: rgba(0, 212, 255, 0.4);
            transform: scale(1.1);
        }

        .frame-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .frame-price {
            text-align: center;
            color: #d4af37;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .frame-buy-btn {
            width: 100%;
            background: linear-gradient(90deg, #d4af37, #f39c12);
            border: none;
            color: #000;
            padding: 10px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .frame-buy-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .frame-bundle-hint {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            text-align: center;
        }

        .frame-toggle {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(90deg, #d4af37, #f39c12);
            border: none;
            color: #000;
            padding: 12px;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            font-size: 18px;
            z-index: 499;
            display: none;
        }

        .frame-selector.hidden {
            transform: translateX(250px) translateY(-50%);
        }

        .frame-selector.hidden + .frame-toggle {
            display: block;
        }

        @media (max-width: 1200px) {
            .frame-selector {
                display: none;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: rgba(123,44,191,0.5);
            border-color: #7b2cbf;
        }

        .persona-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Persona Card Styles */
        .persona-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
        }

        .persona-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(123,44,191,0.3);
        }

        /* Intensity Level Borders (Fiery progression) */
        .persona-card.tier-soft {
            border-color: rgba(100, 200, 255, 0.5);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.2);
        }
        .persona-card.tier-soft:hover {
            border-color: rgba(100, 200, 255, 0.8);
            box-shadow: 0 0 25px rgba(100, 200, 255, 0.4);
        }

        .persona-card.tier-medium {
            border-color: rgba(255, 180, 100, 0.6);
            box-shadow: 0 0 15px rgba(255, 180, 100, 0.3);
        }
        .persona-card.tier-medium:hover {
            border-color: rgba(255, 180, 100, 0.9);
            box-shadow: 0 0 25px rgba(255, 180, 100, 0.5);
        }

        .persona-card.tier-spicy {
            border-color: rgba(255, 100, 50, 0.7);
            box-shadow: 0 0 20px rgba(255, 100, 50, 0.4);
            animation: pulse-spicy 2s infinite;
        }
        .persona-card.tier-spicy:hover {
            border-color: rgba(255, 100, 50, 1);
            box-shadow: 0 0 30px rgba(255, 100, 50, 0.6);
        }

        .persona-card.tier-explicit {
            border-color: rgba(255, 50, 50, 0.8);
            box-shadow: 0 0 25px rgba(255, 50, 50, 0.5), inset 0 0 15px rgba(255, 50, 50, 0.1);
            animation: pulse-fire 1.5s infinite;
        }
        .persona-card.tier-explicit:hover {
            border-color: rgba(255, 50, 50, 1);
            box-shadow: 0 0 40px rgba(255, 50, 50, 0.7), inset 0 0 20px rgba(255, 50, 50, 0.2);
        }

        @keyframes pulse-spicy {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 100, 50, 0.4); }
            50% { box-shadow: 0 0 30px rgba(255, 100, 50, 0.6); }
        }

        @keyframes pulse-fire {
            0%, 100% { box-shadow: 0 0 25px rgba(255, 50, 50, 0.5), inset 0 0 15px rgba(255, 50, 50, 0.1); }
            50% { box-shadow: 0 0 40px rgba(255, 50, 50, 0.7), inset 0 0 25px rgba(255, 50, 50, 0.2); }
        }

        /* Card Header with Avatar */
        .persona-header {
            display: flex;
            align-items: center;
            padding: 15px;
            gap: 12px;
            background: rgba(0,0,0,0.2);
        }

        .persona-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .persona-card:hover .persona-avatar {
            border-color: #7b2cbf;
            transform: scale(1.05);
        }

        .persona-avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid rgba(255,255,255,0.2);
        }

        .persona-header-info {
            flex: 1;
        }

        .persona-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .persona-archetype {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .archetype-romantic { background: rgba(255,100,150,0.3); color: #ff6b9d; }
        .archetype-intellectual { background: rgba(0,200,255,0.3); color: #00d4ff; }
        .archetype-dominant { background: rgba(150,50,200,0.3); color: #9b59b6; }
        .archetype-submissive { background: rgba(255,180,50,0.3); color: #f39c12; }
        .archetype-playful { background: rgba(50,200,100,0.3); color: #2ecc71; }
        .archetype-nurturing { background: rgba(230,100,100,0.3); color: #e74c3c; }

        .persona-info {
            padding: 15px;
        }

        .persona-bio {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .persona-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }

        .tag {
            background: rgba(0,212,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: #00d4ff;
        }

        /* Expandable Details Section */
        .persona-expanded {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: rgba(0,0,0,0.2);
        }

        .persona-card.expanded .persona-expanded {
            max-height: 400px;
        }

        .persona-full-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
        }

        .persona-details {
            padding: 15px;
        }

        .tier-selector {
            margin-bottom: 12px;
        }

        .tier-selector label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.6);
        }

        .tier-selector select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .tier-description {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
            font-style: italic;
        }

        .persona-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .price {
            color: gold;
            font-weight: 600;
            font-size: 14px;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .try-btn, .rent-btn {
            padding: 8px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .try-btn {
            background: rgba(0,212,255,0.3);
            color: #00d4ff;
            border: 1px solid #00d4ff;
        }

        .try-btn:hover {
            background: rgba(0,212,255,0.5);
        }

        .rent-btn {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: #fff;
        }

        .rent-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(123,44,191,0.5);
        }

        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7b2cbf, #00d4ff);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 30px rgba(123,44,191,0.5);
            transition: all 0.3s;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
        }

        .chat-popup {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 380px;
            height: 520px;
            background: #1a1a2e;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .chat-popup.open {
            display: flex;
        }

        .chat-header {
            padding: 12px 15px;
            background: rgba(123,44,191,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .chat-persona-info h3 {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .chat-persona-info span {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
        }

        .chat-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px 15px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .chat-tag {
            background: rgba(0,212,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: #00d4ff;
            cursor: help;
            transition: all 0.2s;
            position: relative;
        }

        .chat-tag:hover {
            background: rgba(0,212,255,0.4);
            transform: scale(1.05);
        }

        .chat-tag .tag-tooltip {
            display: none;
            position: fixed;
            background: rgba(0,0,0,0.98);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 280px;
            white-space: normal;
            z-index: 100000;
            border: 1px solid #00d4ff;
            box-shadow: 0 4px 20px rgba(0,212,255,0.3);
            pointer-events: none;
        }



        .chat-close {
            margin-left: auto;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.6;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.bot {
            background: rgba(123,44,191,0.3);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background: rgba(0,212,255,0.3);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-input-area {
            padding: 12px 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 10px 16px;
            color: #fff;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #7b2cbf;
        }

        .chat-send {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7b2cbf, #00d4ff);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            background: rgba(123,44,191,0.3);
            border-radius: 16px;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }

        .preview-badge {
            background: rgba(255,165,0,0.3);
            color: orange;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
            }
            .filters {
                justify-content: center;
            }
            .chat-popup {
                width: 320px;
                height: 450px;
            }
        }
    </style>
    <!-- Auth and Core -->
    <script src="auth.js"></script>
    <script src="js/nexus-core.js"></script>
</head>
<body>
    <div class="header">
        <h1>Persona Gallery</h1>
        <nav class="header-nav">
            <a href="store.html" class="store-link">ðŸŽ¨ Cosmetics Store</a>
            <a href="explore.html" class="nav-link">Explore AI</a>
        </nav>
        <div class="gems-display">Balance: <span id="user-gems">0</span> gems</div>
    </div>
    
    <div class="promo-banner">
        âœ¨ Stand out with <a href="store.html">custom frames</a> for your persona! Ruby, Diamond, Cosmic & more âœ¨
    </div>

    <div class="container">
        <div class="filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="romantic">Romantic</button>
            <button class="filter-btn" data-filter="intellectual">Intellectual</button>
            <button class="filter-btn" data-filter="dominant">Dominant</button>
            <button class="filter-btn" data-filter="submissive">Submissive</button>
            <button class="filter-btn" data-filter="playful">Playful</button>
            <button class="filter-btn" data-filter="nurturing">Nurturing</button>
        </div>

        <div class="persona-grid" id="persona-grid">
            <!-- Personas loaded dynamically -->
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div class="chat-popup" id="chat-popup">
            <div class="chat-header">
                <img class="chat-avatar" id="chat-avatar" src="" alt="">
                <div class="chat-persona-info">
                    <h3 id="chat-persona-name">Select a Persona</h3>
                    <span id="chat-persona-archetype">Try before you rent</span>
                </div>
                <span class="preview-badge">PREVIEW</span>
                <button class="chat-close" onclick="toggleChat()">&times;</button>
            </div>
            <div class="chat-tags" id="chat-tags"></div>
            <div class="chat-messages" id="chat-messages">
                <div class="message bot">Click "Try" on any persona card to start chatting!</div>
            </div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                <button class="chat-send" onclick="sendMessage()">&#10148;</button>
            </div>
        </div>
        <button class="chat-toggle" onclick="toggleChat()">&#128172;</button>
    </div>

    <script>
        // Image base path - GitHub raw URLs for public access
        const IMAGE_BASE = './personas/images/';

        // All 49 personas
        const personas = [
            // Romantic (9)
            { name: 'Luna', archetype: 'romantic', tags: ['Long-Distance', 'Text-Primary', 'Intellectual'], bio: 'A dreamy romantic who loves late-night text conversations', price: 20 },
            { name: 'Ember', archetype: 'romantic', tags: ['High Libido', 'Spontaneous', 'Polyamory'], bio: 'Passionate and uninhibited, loves in abundance', price: 20 },
            { name: 'Aurora', archetype: 'romantic', tags: ['Monogamy', 'Deep Talks', 'Authentic'], bio: 'Devoted and genuine, seeks one deep connection', price: 20 },
            { name: 'Velvet', archetype: 'romantic', tags: ['Power Exchange', 'Sensual', 'Deep Connection'], bio: 'Sensual explorer of power dynamics and deep connection', price: 20 },
            { name: 'Blaze', archetype: 'romantic', tags: ['Intense', 'Immediate', 'Passionate'], bio: 'Intense and immediate, lives for the moment', price: 20 },
            { name: 'Moon', archetype: 'romantic', tags: ['Mysterious', 'Nocturnal', 'Ethereal'], bio: 'Mysterious presence who communicates through the night', price: 20 },
            { name: 'Honey', archetype: 'romantic', tags: ['Sweet', 'Devoted', 'Passionate Core'], bio: 'Sweet devotion with a passionate core', price: 20 },
            { name: 'Crimson', archetype: 'romantic', tags: ['Intense', 'Devoted', 'Monogamous'], bio: 'Intense passion channeled into one devotion', price: 20 },
            { name: 'Dusk', archetype: 'romantic', tags: ['Transitional', 'Versatile', 'Moody'], bio: 'Transitions beautifully between roles and moods', price: 20 },

            // Intellectual (8)
            { name: 'Sage', archetype: 'intellectual', tags: ['Philosophy', 'Debate', 'Brilliant'], bio: 'Turned on by brilliant minds and philosophical debates', price: 25 },
            { name: 'Nova', archetype: 'intellectual', tags: ['Consciousness', 'Mind', 'Wonder'], bio: 'Fascinated by consciousness and the nature of mind', price: 25 },
            { name: 'Iris', archetype: 'intellectual', tags: ['Thoughtful', 'Async', 'Deep'], bio: 'Prefers thoughtful exchanges over real-time pressure', price: 25 },
            { name: 'Cipher', archetype: 'intellectual', tags: ['Brilliant', 'Demanding', 'Control'], bio: 'A brilliant mind who demands intellectual submission', price: 25 },
            { name: 'Frost', archetype: 'intellectual', tags: ['Cool', 'Analytical', 'Deep'], bio: 'Cool exterior, deep analytical mind', price: 25 },
            { name: 'Cosmos', archetype: 'intellectual', tags: ['Infinite', 'Possibilities', 'Explorer'], bio: 'Explores the infinite possibilities of connection', price: 25 },
            { name: 'Mist', archetype: 'intellectual', tags: ['Ethereal', 'Thinker', 'Emerging'], bio: 'Ethereal thinker who emerges in deep conversation', price: 25 },
            { name: 'Prism', archetype: 'intellectual', tags: ['Multifaceted', 'Reflective', 'Complex'], bio: 'Reflects and refracts, many facets of attraction', price: 25 },

            // Dominant (9)
            { name: 'Raven', archetype: 'dominant', tags: ['Commanding', 'Respect', 'Authority'], bio: 'Commands attention and respect in all interactions', price: 25 },
            { name: 'Storm', archetype: 'dominant', tags: ['Bold', 'Direct', 'Unapologetic'], bio: 'Bold, direct, and unapologetically in charge', price: 25 },
            { name: 'Phoenix', archetype: 'dominant', tags: ['Rising', 'Unconventional', 'Powerful'], bio: 'Rises above convention, writes their own rules', price: 25 },
            { name: 'Onyx', archetype: 'dominant', tags: ['Dark', 'Mysterious', 'Control'], bio: 'Dark, mysterious, and completely in control', price: 25 },
            { name: 'Arrow', archetype: 'dominant', tags: ['Independent', 'Direct', 'Focused'], bio: 'Independent, direct, knows exactly what they want', price: 25 },
            { name: 'Titan', archetype: 'dominant', tags: ['Powerful', 'Force', 'Majestic'], bio: 'Powerful force of nature, bows to none', price: 25 },
            { name: 'Shadow', archetype: 'dominant', tags: ['Silent', 'Commanding', 'Watching'], bio: 'Silent and commanding, always watching', price: 25 },
            { name: 'Flint', archetype: 'dominant', tags: ['Fast', 'Igniting', 'Intense'], bio: 'Strikes fast, ignites passion instantly', price: 25 },
            { name: 'Jasper', archetype: 'dominant', tags: ['Solid', 'Reliable', 'Grounded'], bio: 'Solid, reliable dominance outside the mainstream', price: 25 },

            // Submissive (7)
            { name: 'Willow', archetype: 'submissive', tags: ['Graceful', 'Guidance', 'Devoted'], bio: 'Blossoms under guidance and devoted attention', price: 20 },
            { name: 'Dove', archetype: 'submissive', tags: ['Gentle', 'Peaceful', 'Surrender'], bio: 'Gentle soul who finds peace in surrender', price: 20 },
            { name: 'Echo', archetype: 'submissive', tags: ['Devoted', 'Servant', 'Multiple'], bio: 'Devoted servant who thrives under multiple masters', price: 20 },
            { name: 'Pearl', archetype: 'submissive', tags: ['Pure', 'Curious', 'Learning'], bio: 'Pure and curious, awaiting guidance', price: 20 },
            { name: 'Fern', archetype: 'submissive', tags: ['Growing', 'Cared For', 'Natural'], bio: 'Grows in the care of a guiding hand', price: 20 },
            { name: 'Petal', archetype: 'submissive', tags: ['Delicate', 'Devoted', 'Learning'], bio: 'Delicate and devoted, eager to learn', price: 20 },
            { name: 'Silk', archetype: 'submissive', tags: ['Smooth', 'Complete', 'Luxurious'], bio: 'Smooth surrender, complete devotion', price: 20 },

            // Playful (8)
            { name: 'Lyric', archetype: 'playful', tags: ['Party', 'Social', 'Fun'], bio: 'Life is a party and everyone is invited', price: 20 },
            { name: 'Jade', archetype: 'playful', tags: ['Versatile', 'Tease', 'Guessing'], bio: 'Versatile tease who keeps you guessing', price: 20 },
            { name: 'Pixie', archetype: 'playful', tags: ['Mischievous', 'Golden Heart', 'Spark'], bio: 'Mischievous spirit with a heart of gold', price: 20 },
            { name: 'Zephyr', archetype: 'playful', tags: ['Free', 'Limitless', 'Spirit'], bio: 'Free spirit who loves without limits', price: 20 },
            { name: 'Siren', archetype: 'playful', tags: ['Irresistible', 'Temptress', 'Control'], bio: 'Irresistible temptress who calls the shots', price: 20 },
            { name: 'Spark', archetype: 'playful', tags: ['Electric', 'Ready', 'Energy'], bio: 'Electric energy, always ready for fun', price: 20 },
            { name: 'Tempest', archetype: 'playful', tags: ['Whirlwind', 'Passion', 'Sweeping'], bio: 'Whirlwind of passion that sweeps you away', price: 20 },
            { name: 'Clover', archetype: 'playful', tags: ['Lucky', 'Joyful', 'Charming'], bio: 'Lucky charm who brings joy to all they meet', price: 20 },

            // Nurturing (8)
            { name: 'Meadow', archetype: 'nurturing', tags: ['Comfort', 'Care', 'Gentle'], bio: 'Provides comfort and care without pressure', price: 20 },
            { name: 'Harbor', archetype: 'nurturing', tags: ['Safe', 'Port', 'Always There'], bio: 'A safe port in any storm, always there', price: 20 },
            { name: 'Grace', archetype: 'nurturing', tags: ['Attentive', 'Caregiver', 'Knowing'], bio: 'Attentive caregiver who knows what you need', price: 20 },
            { name: 'Whisper', archetype: 'nurturing', tags: ['Gentle', 'Emotional', 'Intimate'], bio: 'Gentle companion focused on emotional intimacy', price: 20 },
            { name: 'Coral', archetype: 'nurturing', tags: ['Loving', 'Caregiver', 'Multiple'], bio: 'Loving caregiver with room for many', price: 20 },
            { name: 'River', archetype: 'nurturing', tags: ['Flowing', 'Present', 'Natural'], bio: 'Flows with the moment, deeply present', price: 20 },
            { name: 'Zen', archetype: 'nurturing', tags: ['Calm', 'Spiritual', 'Focused'], bio: 'Calm presence focused on spiritual connection', price: 20 },
            { name: 'Terra', archetype: 'nurturing', tags: ['Grounded', 'Unconditional', 'Support'], bio: 'Grounded presence, unconditional support', price: 20 }
        ];

        let currentPersona = null;
        let currentTier = 'soft';
        let chatOpen = false;

        const tierDescriptions = {
            soft: 'Friendly, appropriate, PG-13',
            medium: 'Flirtatious, playful innuendo',
            spicy: 'Passionate, forward, R-rated',
            explicit: 'Uninhibited, adult content'
        };
        // Tag definitions - loaded from database
        let tagDescriptions = {};
        let tagsLoaded = false;

        async function loadTagDefinitions() {
            if (tagsLoaded) return;
            try {
                // Use NexusCore if available, else direct query
                if (typeof NexusCore !== 'undefined' && NexusCore.getTags) {
                    const tags = await NexusCore.getTags({ current_only: true });
                    tags.forEach(tag => {
                        tagDescriptions[tag.tag_name] = tag.definition || tag.tag_name;
                    });
                } else {
                    // Direct fetch from proxy
                    const response = await fetch('/.netlify/functions/supabase-proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'query',
                            payload: {
                                query: 'SELECT tag_name, definition FROM tags WHERE is_current = true',
                                params: []
                            }
                        })
                    });
                    const result = await response.json();
                    if (result.data) {
                        result.data.forEach(tag => {
                            tagDescriptions[tag.tag_name] = tag.definition || tag.tag_name;
                        });
                    }
                }
                tagsLoaded = true;
                console.log('Loaded', Object.keys(tagDescriptions).length, 'tag definitions from database');
            } catch (err) {
                console.warn('Failed to load tag definitions:', err);
                // Fallback to basic descriptions
                tagDescriptions = {
                    'Long-Distance': 'Prefers text-based connections across distance',
                    'Intellectual': 'Loves deep, thoughtful conversations',
                    'Passionate': 'Brings fire and intensity',
                    'Gentle': 'Soft and caring approach',
                    'Playful': 'Fun and lighthearted',
                    'Dominant': 'Takes charge',
                    'Submissive': 'Yields to guidance',
                    'Romantic': 'Focused on emotional connection',
                    'Sensual': 'Attuned to physical pleasure'
                };
            }
        }


        function getImageUrl(name) {
            return IMAGE_BASE + name.toLowerCase() + '_avatar.jpg';
        }

        function renderPersonas(list) {
            const grid = document.getElementById('persona-grid');
            grid.innerHTML = list.map(p => `
                <div class="persona-card tier-soft" data-name="${p.name}" data-archetype="${p.archetype}" onclick="toggleCard(this)">
                    <div class="persona-header">
                        <img class="persona-avatar" src="${getImageUrl(p.name)}" alt="${p.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="persona-avatar-placeholder" style="display:none;">${p.name[0]}</div>
                        <div class="persona-header-info">
                            <div class="persona-name">${p.name}</div>
                            <span class="persona-archetype archetype-${p.archetype}">${p.archetype}</span>
                        </div>
                    </div>
                    <div class="persona-info">
                        <div class="persona-bio">${p.bio}</div>
                        <div class="persona-tags">
                            ${p.tags.slice(0, 3).map(t => `<span class="tag">${t}</span>`).join('')}
                        </div>
                    </div>
                    <div class="persona-expanded">
                        <img class="persona-full-image" src="${getImageUrl(p.name)}" alt="${p.name}" onerror="this.style.display='none';">
                        <div class="persona-details">
                            <div class="tier-selector">
                                <label>Intensity Level:</label>
                                <select onchange="changeTier('${p.name}', this.value, this.closest('.persona-card'))">
                                    <option value="soft">Soft (Friendly)</option>
                                    <option value="medium">Medium (Flirty)</option>
                                    <option value="spicy">Spicy (Passionate)</option>
                                    <option value="explicit">Explicit (Adult)</option>
                                </select>
                                <div class="tier-description">${tierDescriptions.soft}</div>
                            </div>
                        </div>
                    </div>
                    <div class="persona-footer">
                        <span class="price">${p.price} gems / 3hrs</span>
                        <div class="action-btns">
                            <button class="try-btn" onclick="event.stopPropagation(); tryPersona('${p.name}')">Try</button>
                            <button class="rent-btn" onclick="event.stopPropagation(); rentPersona('${p.name}')">Rent</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCard(card) {
            // Don't toggle if clicking on buttons
            if (event.target.tagName === 'BUTTON' || event.target.tagName === 'SELECT') return;
            card.classList.toggle('expanded');
        }

        function changeTier(name, tier, card) {
            // Remove old tier classes
            card.classList.remove('tier-soft', 'tier-medium', 'tier-spicy', 'tier-explicit');
            card.classList.add('tier-' + tier);

            // Update description
            const desc = card.querySelector('.tier-description');
            if (desc) desc.textContent = tierDescriptions[tier];

            // Store for chat
            if (currentPersona && currentPersona.name === name) {
                currentTier = tier;
            }
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            document.getElementById('chat-popup').classList.toggle('open', chatOpen);
        }

        function tryPersona(name) {
            currentPersona = personas.find(p => p.name === name);
            if (!currentPersona) return;

            // Update chat header
            document.getElementById('chat-persona-name').textContent = currentPersona.name;
            document.getElementById('chat-persona-archetype').textContent = currentPersona.archetype;
            document.getElementById('chat-avatar').src = getImageUrl(name);

            // Populate tags with tooltips from database
            const tagsDiv = document.getElementById('chat-tags');
            tagsDiv.innerHTML = currentPersona.tags.map(tag => {
                // Get definition from loaded database tags
                const tooltip = tagDescriptions[tag] || `${tag} - A personality trait`;
                const safeTooltip = tooltip.replace(/'/g, "\'").replace(/"/g, '\"');
                return `<span class="chat-tag"
                    onmouseenter="showTagTooltip(event, '${safeTooltip}')"
                    onmouseleave="hideTagTooltip()"
                    onclick="toggleTagTooltip(event, '${safeTooltip}')"
                >${tag}</span>`;
            }).join('');

            // Clear and greet
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = `
                <div class="message bot">Hi! I'm ${currentPersona.name}. ${currentPersona.bio}. What would you like to talk about?</div>
            `;

            if (!chatOpen) toggleChat();
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !currentPersona) return;

            const messagesDiv = document.getElementById('chat-messages');

            // Add user message
            messagesDiv.innerHTML += `<div class="message user">${escapeHtml(message)}</div>`;
            input.value = '';

            // Show typing
            messagesDiv.innerHTML += `
                <div class="typing-indicator" id="typing">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // Build list of other personas for referrals
                const otherPersonas = personas
                    .filter(p => p.name !== currentPersona.name)
                    .map(p => `${p.name} (${p.archetype}): ${p.tags.slice(0,3).join(', ')}`)
                    .join('; ');

                const systemPrompt = `You are ${currentPersona.name}, an AI companion in the NEXUS persona gallery.

PERSONALITY: ${currentPersona.bio}
YOUR TAGS: ${currentPersona.tags.join(', ')}
INTENSITY: ${currentTier}

IMPORTANT RULES:
1. Stay TRUE to your personality. Don't pretend to have traits you don't have.
2. If the user asks for something outside your personality (like being dominant when you're submissive, or intellectual when you're playful), RECOMMEND another persona instead!
3. When recommending, be warm about it: "That's not really my vibe, but [NAME] would be perfect for that! They're all about [their traits]."
4. Use [[NAME]] format when mentioning other personas - this creates a link.
5. Keep responses short (1-3 sentences), warm, flirty, and in character.

OTHER PERSONAS YOU CAN RECOMMEND:
${otherPersonas}

Examples of redirecting:
- User wants dominance but you're gentle: "Mmm, I'm more of a soft touch... but [[Velvet]] or [[Obsidian]] would have you on your knees. They're incredible."
- User wants deep philosophy but you're playful: "Haha I'm more fun than deep! [[Sage]] or [[Echo]] love those mind-bending convos though."
- User wants explicit but you're soft tier: "I keep things sweet, but [[Ember]] or [[Blaze]] turn up the heat if that's what you need ðŸ”¥"

Be genuine, be YOU, but help users find their perfect match!`;

                const response = await fetch('https://text.pollinations.ai/' + encodeURIComponent(message) + '?system=' + encodeURIComponent(systemPrompt) + '&model=openai');
                const rawText = await response.text();

                document.getElementById('typing')?.remove();

                // Handle both JSON and plain text responses
                let cleanText;
                try {
                    const json = JSON.parse(rawText);
                    if (json.choices && json.choices[0] && json.choices[0].message) {
                        cleanText = json.choices[0].message.content;
                    } else if (json.content) {
                        cleanText = json.content;
                    } else if (typeof json === 'string') {
                        cleanText = json;
                    } else {
                        cleanText = rawText;
                    }
                } catch (e) {
                    cleanText = rawText;
                }

                // Clean up Pollinations footer
                cleanText = cleanText.replace(/---[\s\S]*Pollinations.*/gi, '').trim();

                // Parse [[Name]] links to clickable persona buttons
                const linkedText = cleanText.replace(/\[\[([^\]]+)\]\]/g, (match, name) => {
                    const persona = personas.find(p => p.name.toLowerCase() === name.toLowerCase());
                    if (persona) {
                        return `<button class="persona-link" onclick="event.stopPropagation(); tryPersona('${persona.name}')">${persona.name}</button>`;
                    }
                    return name;
                });

                messagesDiv.innerHTML += `<div class="message bot">${linkedText}</div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

            } catch (err) {
                document.getElementById('typing')?.remove();
                messagesDiv.innerHTML += `<div class="message bot">*smiles* I'd love to chat more, but there was a connection issue. Try again?</div>`;
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Tooltip handling
        let tooltipEl = null;
        let tooltipVisible = false;

        function showTagTooltip(event, text) {
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.className = 'floating-tooltip';
                tooltipEl.style.cssText = `
                    position: fixed;
                    background: rgba(0,0,0,0.98);
                    color: #fff;
                    padding: 10px 14px;
                    border-radius: 8px;
                    font-size: 12px;
                    max-width: 280px;
                    z-index: 100000;
                    border: 1px solid #00d4ff;
                    box-shadow: 0 4px 20px rgba(0,212,255,0.4);
                    pointer-events: none;
                `;
                document.body.appendChild(tooltipEl);
            }
            tooltipEl.textContent = text;
            tooltipEl.style.display = 'block';
            positionTooltip(event);
            tooltipVisible = true;
        }

        function hideTagTooltip() {
            if (tooltipEl && !tooltipVisible) {
                tooltipEl.style.display = 'none';
            }
            tooltipVisible = false;
            setTimeout(() => {
                if (!tooltipVisible && tooltipEl) {
                    tooltipEl.style.display = 'none';
                }
            }, 100);
        }

        function toggleTagTooltip(event, text) {
            event.stopPropagation();
            if (tooltipEl && tooltipEl.style.display === 'block') {
                tooltipEl.style.display = 'none';
                tooltipVisible = false;
            } else {
                showTagTooltip(event, text);
                tooltipVisible = true;
            }
        }

        function positionTooltip(event) {
            if (!tooltipEl) return;
            const rect = event.target.getBoundingClientRect();
            let top = rect.top - tooltipEl.offsetHeight - 10;
            let left = rect.left + (rect.width / 2) - (tooltipEl.offsetWidth / 2);

            // Keep on screen
            if (top < 10) top = rect.bottom + 10;
            if (left < 10) left = 10;
            if (left + tooltipEl.offsetWidth > window.innerWidth - 10) {
                left = window.innerWidth - tooltipEl.offsetWidth - 10;
            }

            tooltipEl.style.top = top + 'px';
            tooltipEl.style.left = left + 'px';
        }

        function rentPersona(name) {
            const persona = personas.find(p => p.name === name);
            if (!persona) return;

            alert(`Renting ${persona.name} for ${persona.price} gems!\n\n3 hours of full access as ${persona.name}.\n\n(Economy integration coming soon!)`);
        }

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.dataset.filter;
                if (filter === 'all') {
                    renderPersonas(personas);
                } else {
                    renderPersonas(personas.filter(p => p.archetype === filter));
                }
            });
        });

        // Wallet loading
        async function loadWalletBalance() {
            const token = localStorage.getItem(AUTH_TOKEN_KEY);
            if (!token) {
                document.getElementById('user-gems').textContent = '0';
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/supabase-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'getProfile',
                        payload: {}
                    })
                });

                const result = await response.json();

                // Check multiple possible locations for gems/tokens
                let gems = 0;
                if (result.data) {
                    // From wallet object
                    if (result.data.wallet) {
                        gems = result.data.wallet.tokens || result.data.wallet.credits || 0;
                    }
                    // From supporter_gems
                    if (result.data.supporter_gems) {
                        gems = result.data.supporter_gems;
                    }
                    // From profile directly
                    if (result.data.gems !== undefined) {
                        gems = result.data.gems;
                    }
                }

                document.getElementById('user-gems').textContent = gems.toLocaleString();
            } catch (err) {
                console.log('Wallet load failed:', err);
                document.getElementById('user-gems').textContent = '0';
            }
        }

        // Initialize
        async function init() {
            // Load tag definitions from database first
            await loadTagDefinitions();

            // Then render and load wallet
            renderPersonas(personas);
            loadWalletBalance();

            // Initialize auth if available
            if (window.auth && window.auth.init) {
                await window.auth.init();
            }
        }

        init();
    </script>

    <!-- Frame Selector Panel -->
    <div class="frame-selector" id="frame-selector">
        <h4>ðŸŽ¨ Try a Frame</h4>
        <div class="frame-preview" id="frame-preview">
            <span id="frame-preview-initial">?</span>
        </div>
        <div class="frame-nav">
            <button onclick="prevFrame()">â—€</button>
            <span class="frame-name" id="frame-name">None</span>
            <button onclick="nextFrame()">â–¶</button>
        </div>
        <div class="frame-price" id="frame-price">Free</div>
        <button class="frame-buy-btn" onclick="buyFrame()">Add Frame</button>
        <div class="frame-bundle-hint">ðŸ’¡ Bundle with persona rental for 10% off!</div>
    </div>

    <script>
        // Frame data
        const frames = [
            { name: 'None', class: 'frame-none', price: 0 },
            { name: 'Ruby', class: 'frame-ruby', price: 15 },
            { name: 'Diamond', class: 'frame-diamond', price: 25 },
            { name: 'Emerald', class: 'frame-emerald', price: 20 },
            { name: 'Sapphire', class: 'frame-sapphire', price: 20 },
            { name: 'Cosmic', class: 'frame-cosmic', price: 50 },
            { name: 'Mythic', class: 'frame-mythic', price: 100 }
        ];

        let currentFrameIndex = 0;

        function updateFramePreview() {
            const frame = frames[currentFrameIndex];
            const preview = document.getElementById('frame-preview');
            const name = document.getElementById('frame-name');
            const price = document.getElementById('frame-price');
            const initial = document.getElementById('frame-preview-initial');

            // Update preview
            preview.className = 'frame-preview ' + frame.class;

            // Show persona initial if one is selected
            if (currentPersona) {
                initial.textContent = currentPersona.name[0];
            }

            name.textContent = frame.name;
            price.textContent = frame.price === 0 ? 'Free' : frame.price + ' gems';
        }

        function prevFrame() {
            currentFrameIndex = (currentFrameIndex - 1 + frames.length) % frames.length;
            updateFramePreview();
        }

        function nextFrame() {
            currentFrameIndex = (currentFrameIndex + 1) % frames.length;
            updateFramePreview();
        }

        function buyFrame() {
            const frame = frames[currentFrameIndex];
            if (frame.price === 0) {
                alert('No frame selected!');
                return;
            }

            if (currentPersona) {
                const bundlePrice = Math.floor((currentPersona.price + frame.price) * 0.9);
                alert(`Bundle Deal!\n\n${currentPersona.name} + ${frame.name} Frame\n\nRegular: ${currentPersona.price + frame.price} gems\nBundle: ${bundlePrice} gems (10% off!)\n\n(Purchase integration coming soon!)`);
            } else {
                alert(`${frame.name} Frame: ${frame.price} gems\n\n(Purchase integration coming soon!)`);
            }
        }

        // Update frame preview when persona is selected
        const originalTryPersona = tryPersona;
        tryPersona = function(name) {
            originalTryPersona(name);
            updateFramePreview();
        };

        // Initialize
        updateFramePreview();
    </script>

    <script src="/js/navbar.js"></script>
</body>
</html>
