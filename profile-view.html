<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-24HL4B73C3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-24HL4B73C3');
</script>

  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#00d4ff">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Preview - NEXUS</title>

  <link rel="stylesheet" href="/css/nexus-base.css">

  <style>
    body {
      padding-top: 80px;
    }

    .profile-view-container {
      max-width: 900px;
      margin: 0 auto;
      padding: var(--spacing-xl) var(--spacing-md);
    }

    .preview-banner {
      background: rgba(212, 175, 55, 0.1);
      border: 2px solid var(--highlight-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }

    .preview-banner h3 {
      color: var(--highlight-color);
      margin: 0 0 var(--spacing-xs) 0;
    }

    .profile-header {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-xl);
      background: var(--primary-bg);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: var(--radius-md);
      position: relative;
    }

    .profile-avatar-container {
      position: relative;
      width: 150px;
      height: 150px;
      flex-shrink: 0;
    }

    .profile-avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      color: var(--gunmetal);
      font-weight: bold;
      border: 3px solid var(--accent-color);
      box-shadow: var(--shadow-lg), var(--glow-aqua);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-family: var(--font-heading);
      font-size: 2rem;
      margin: 0 0 var(--spacing-xs) 0;
      background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .profile-username {
      color: var(--accent-color);
      font-size: 1.1rem;
      margin: 0 0 var(--spacing-md) 0;
      opacity: 0.8;
    }

    .profile-bio {
      font-size: 1.05rem;
      line-height: 1.6;
      margin: var(--spacing-md) 0;
      opacity: 0.9;
    }

    .profile-meta {
      display: flex;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .section {
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--primary-bg);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: var(--radius-md);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid rgba(0, 212, 255, 0.3);
    }

    .section-title {
      font-family: var(--font-heading);
      font-size: 1.4rem;
      color: var(--accent-color);
      margin: 0;
    }

    .tags-display {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid var(--accent-color);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      color: var(--text-light);
      transition: all var(--transition-fast);
    }

    .tag:hover {
      background: rgba(0, 212, 255, 0.2);
      box-shadow: var(--glow-aqua);
    }

    /* Matching tags get special highlight */
    .tag.matching {
      background: rgba(212, 175, 55, 0.2);
      border-color: var(--highlight-color);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
    }

    .tag.matching::before {
      content: '‚úì ';
      color: var(--highlight-color);
    }

    .tag.matching:hover {
      background: rgba(212, 175, 55, 0.3);
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
    }

    /* Comparison panel styles */
    .comparison-panel {
      background: rgba(0, 212, 255, 0.05);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }

    .comparison-stat {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-sm);
    }

    .comparison-bar {
      flex: 1;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .comparison-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .comparison-bar-fill.you {
      background: var(--accent-color);
      position: absolute;
      left: 0;
    }

    .comparison-bar-fill.them {
      background: var(--highlight-color);
      position: absolute;
      left: 0;
    }

    .comparison-legend {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
      margin-top: var(--spacing-sm);
      font-size: 0.85rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.you { background: var(--accent-color); }
    .legend-dot.them { background: var(--highlight-color); }

    .match-summary {
      text-align: center;
      padding: var(--spacing-md);
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(212, 175, 55, 0.1));
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    .match-percentage {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-color), var(--highlight-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .gender-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: 2px 8px;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
    }

    .tag-version {
      font-size: 0.7rem;
      opacity: 0.6;
    }

    .intensity-indicator {
      display: inline-flex;
      align-items: flex-end;
      gap: 2px;
      height: 12px;
      vertical-align: middle;
    }

    .intensity-bar {
      width: 3px;
      border-radius: 1px;
      transition: all 0.2s ease;
    }

    .intensity-bar:nth-child(1) { height: 20%; }
    .intensity-bar:nth-child(2) { height: 40%; }
    .intensity-bar:nth-child(3) { height: 60%; }
    .intensity-bar:nth-child(4) { height: 80%; }
    .intensity-bar:nth-child(5) { height: 100%; }

    .intensity-bar.active.level-1 { background: #ff4444; }
    .intensity-bar.active.level-2 { background: #ff8844; }
    .intensity-bar.active.level-3 { background: #ffcc44; }
    .intensity-bar.active.level-4 { background: #88ff44; }
    .intensity-bar.active.level-5 { background: #44ff88; }

    .intensity-bar:not(.active) {
      background: rgba(255, 255, 255, 0.15);
    }

    .connection-pattern-text {
      padding: var(--spacing-md);
      background: rgba(0, 212, 255, 0.05);
      border-left: 3px solid var(--accent-color);
      border-radius: var(--radius-sm);
      font-size: 1.05rem;
      line-height: 1.7;
      font-style: italic;
    }

    .photo-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .photo-item {
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(0, 212, 255, 0.3);
      cursor: pointer;
      transition: all var(--transition-normal);
    }

    .photo-item:hover {
      border-color: var(--accent-color);
      box-shadow: var(--glow-aqua);
      transform: scale(1.02);
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      opacity: 0.6;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }

      .profile-meta {
        justify-content: center;
      }
    }
  </style>
</head>
<body>


  <div class="profile-view-container">
    <!-- Banner - changes based on whether viewing own profile or another user's -->
    <div class="preview-banner" id="previewBanner">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
        <div style="flex: 1;">
          <h3 style="margin: 0 0 var(--spacing-xs) 0;" id="bannerTitle">üëÅÔ∏è Public Profile Preview</h3>
          <p style="margin: 0; opacity: 0.9;" id="bannerDescription">This is how other users see your profile when viewing it as a connection.</p>
        </div>
        <div id="bannerActions">
          <a href="/profile.html" class="btn btn-primary">
            ‚Üê Return to Profile
          </a>
        </div>
      </div>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-avatar-container">
        <div class="profile-avatar" id="profileAvatar">?</div>
      </div>
      <div class="profile-info">
        <h1 class="profile-name" id="profileName">Loading...</h1>
        <p class="profile-username" id="profileUsername">@username</p>
        <p class="profile-bio" id="profileBio"></p>
        <div class="profile-meta" id="profileMeta">
          <!-- Meta info populated by JS -->
        </div>
      </div>
    </div>

    <!-- Compatibility Comparison Panel (only shown when viewing others) -->
    <div class="section" id="comparisonSection" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">Compatibility Overview</h2>
      </div>

      <div class="match-summary">
        <div class="match-percentage" id="matchPercentage">--</div>
        <div style="opacity: 0.8; margin-top: var(--spacing-xs);">Tag Overlap</div>
        <div style="font-size: 0.9rem; opacity: 0.6; margin-top: var(--spacing-xs);" id="matchCount">-- matching tags</div>
      </div>

      <div class="comparison-panel" id="interestComparison">
        <div class="comparison-header">
          <h4 style="margin: 0; color: var(--accent-color);">Interest Levels</h4>
        </div>
        <div id="interestComparisonContent">
          <!-- Populated by JS -->
        </div>
        <div class="comparison-legend">
          <div class="legend-item"><span class="legend-dot you"></span> You</div>
          <div class="legend-item"><span class="legend-dot them"></span> Them</div>
        </div>
      </div>

      <div class="comparison-panel" id="experienceComparison">
        <div class="comparison-header">
          <h4 style="margin: 0; color: var(--accent-color);">Experience Levels</h4>
        </div>
        <div id="experienceComparisonContent">
          <!-- Populated by JS -->
        </div>
        <div class="comparison-legend">
          <div class="legend-item"><span class="legend-dot you"></span> You</div>
          <div class="legend-item"><span class="legend-dot them"></span> Them</div>
        </div>
      </div>
    </div>

    <!-- Connection Pattern Tags -->
    <div class="section" id="tagsSection">
      <div class="section-header">
        <h2 class="section-title">Connection Tags</h2>
      </div>
      <div class="tags-display" id="tagsDisplay">
        <div class="empty-state">Loading tags...</div>
      </div>
    </div>

    <!-- Additional Photos -->
    <div class="section" id="photosSection" style="display: none;">
      <div class="section-header">
        <h2 class="section-title">Photos</h2>
      </div>
      <div class="photo-gallery" id="photoGallery">
        <!-- Photos populated by JS -->
      </div>
    </div>
  </div>

  <script src="/auth.js"></script>
  <script src="/js/navbar.js"></script>
  <script src="/js/nexus-core.js"></script>
  <script>
    let viewingUserId = null;
    let currentUserId = null;
    let isPreviewMode = false; // Only true when explicitly previewing from profile editor
    let currentUserTags = []; // Store current user's tags for comparison

    // Get user ID from URL parameter
    function getUserIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('user');
    }

    // Check if this is preview mode (explicitly requested via URL param)
    function isPreviewModeFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('preview') === 'true';
    }

    // Update banner based on whether this is preview mode, own profile, or another user's profile
    function updateBanner(profile) {
      const bannerTitle = document.getElementById('bannerTitle');
      const bannerDescription = document.getElementById('bannerDescription');
      const bannerActions = document.getElementById('bannerActions');
      const previewBanner = document.getElementById('previewBanner');
      // Compare as strings to avoid type mismatch issues
      const isOwnProfile = currentUserId && String(currentUserId) === String(viewingUserId);

      if (isPreviewMode) {
        // Preview mode - came from profile editor to see how profile looks
        bannerTitle.textContent = 'üëÅÔ∏è Public Profile Preview';
        bannerDescription.textContent = 'This is how other users see your profile when viewing it as a connection.';
        bannerActions.innerHTML = `
          <a href="/profile.html" class="btn btn-primary">
            ‚Üê Return to Profile
          </a>
        `;
        previewBanner.style.borderColor = 'var(--highlight-color)';
        previewBanner.style.background = 'rgba(212, 175, 55, 0.1)';
      } else if (isOwnProfile) {
        // Viewing own profile from Explore (not preview mode)
        bannerTitle.textContent = 'üë§ This is Your Profile';
        bannerDescription.textContent = 'This is how your public profile appears to other users.';
        bannerActions.innerHTML = `
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
            <a href="/profile.html" class="btn btn-primary">
              Edit Profile
            </a>
            <a href="/explore.html" class="btn btn-outline">
              ‚Üê Back to Explore
            </a>
          </div>
        `;
        previewBanner.style.borderColor = 'var(--highlight-color)';
        previewBanner.style.background = 'rgba(212, 175, 55, 0.1)';
      } else {
        // Viewing another user's profile
        const displayName = profile.display_name || 'User';
        bannerTitle.textContent = `üë§ ${displayName}'s Profile`;
        bannerDescription.textContent = 'Viewing public profile';
        bannerActions.innerHTML = `
          <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap; align-items: center;">
            <button onclick="sendConnectionRequest('${viewingUserId}')" class="btn btn-primary" id="connectBtn">
              Connect
            </button>
            <a href="/messages.html?user=${viewingUserId}" class="btn btn-secondary" id="messageBtn">
              Message
            </a>
            <a href="/explore.html" class="btn btn-outline">
              ‚Üê Back to Explore
            </a>
            <button onclick="toggleBlockMenu()" class="btn btn-outline" style="padding: 8px; min-width: auto;" title="More options">
              ‚ãÆ
            </button>
            <div id="blockMenu" style="display: none; position: absolute; right: 0; top: 100%; background: var(--gunmetal); border: 1px solid rgba(255,100,100,0.3); border-radius: var(--radius-sm); padding: var(--spacing-sm); z-index: 100;">
              <button onclick="blockThisUser()" style="color: #ff6666; background: none; border: none; cursor: pointer; padding: var(--spacing-sm); width: 100%; text-align: left;">
                üö´ Block User
              </button>
            </div>
          </div>
        `;
        previewBanner.style.borderColor = 'var(--accent-color)';
        previewBanner.style.background = 'rgba(0, 212, 255, 0.1)';

        // Check connection status and update buttons
        updateActionButtons();
      }
    }

    // Toggle block menu
    function toggleBlockMenu() {
      const menu = document.getElementById('blockMenu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    // Block user
    async function blockThisUser() {
      if (!confirm('Are you sure you want to block this user? They will not be able to contact you or see your profile.')) {
        return;
      }
      try {
        await NexusCore.blockUser(viewingUserId);
        NexusCore.showToast('User blocked', 'success');
        window.location.href = '/explore.html';
      } catch (error) {
        console.error('Failed to block user:', error);
        NexusCore.showToast('Failed to block user', 'error');
      }
    }

    // Update action buttons based on connection/messaging status
    async function updateActionButtons() {
      const connectBtn = document.getElementById('connectBtn');
      const messageBtn = document.getElementById('messageBtn');

      // Check connection status
      const connectionStatus = await NexusCore.getConnectionStatus(viewingUserId);

      if (connectionStatus.status === 'accepted') {
        connectBtn.textContent = 'Connected ‚úì';
        connectBtn.disabled = true;
        connectBtn.style.opacity = '0.6';
      } else if (connectionStatus.status === 'pending') {
        if (connectionStatus.isInitiator) {
          connectBtn.textContent = 'Request Sent';
          connectBtn.disabled = true;
          connectBtn.style.opacity = '0.6';
        } else {
          connectBtn.textContent = 'Accept Request';
          connectBtn.onclick = () => acceptConnectionRequest(connectionStatus.matchId);
        }
      }

      // Check messaging permission
      const msgStatus = await NexusCore.canMessage(viewingUserId);
      if (!msgStatus.canMessage) {
        messageBtn.title = msgStatus.reason;
        if (connectionStatus.status !== 'accepted') {
          messageBtn.style.opacity = '0.6';
          messageBtn.onclick = (e) => {
            e.preventDefault();
            NexusCore.showToast(msgStatus.reason, 'info');
          };
        }
      }
    }

    // Accept connection request
    async function acceptConnectionRequest(matchId) {
      try {
        await NexusCore.updateMatchStatus(matchId, 'accepted');
        NexusCore.showToast('Connection accepted!', 'success');
        location.reload();
      } catch (error) {
        console.error('Failed to accept connection:', error);
        NexusCore.showToast('Failed to accept connection', 'error');
      }
    }

    // Send connection request
    async function sendConnectionRequest(targetUserId) {
      // Prevent connecting with yourself
      if (targetUserId === currentUserId) {
        NexusCore.showToast('You cannot connect with yourself', 'error');
        return;
      }
      try {
        await NexusCore.createMatchRequest(targetUserId, 50); // Default compatibility
        NexusCore.showToast('Connection request sent!', 'success');
        // Update button state
        const connectBtn = document.getElementById('connectBtn');
        connectBtn.textContent = 'Request Sent';
        connectBtn.disabled = true;
        connectBtn.style.opacity = '0.6';
      } catch (error) {
        console.error('Failed to send connection request:', error);
        NexusCore.showToast('Failed to send connection request', 'error');
      }
    }

    // Generate intensity indicator
    function getIntensityIndicator(intensity) {
      const bars = [];
      for (let i = 1; i <= 5; i++) {
        const isActive = i <= intensity;
        const levelClass = isActive ? `level-${intensity}` : '';
        bars.push(`<div class="intensity-bar ${isActive ? 'active' : ''} ${levelClass}"></div>`);
      }
      return `<div class="intensity-indicator">${bars.join('')}</div>`;
    }

    // Calculate age from birth date
    function calculateAge(birthDate) {
      if (!birthDate) return null;
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }

    // Load profile data
    async function loadProfile() {
      try {
        // Initialize auth to get current user
        await window.auth.init();
        currentUserId = NexusCore.getUserId();

        viewingUserId = getUserIdFromUrl();

        if (!viewingUserId) {
          document.querySelector('.profile-view-container').innerHTML = `
            <div class="empty-state">
              <p style="font-size: 1.2rem; color: var(--accent-color);">No user specified</p>
              <p>Please provide a user ID in the URL.</p>
            </div>
          `;
          return;
        }

        // Determine if this is preview mode (explicitly from profile editor)
        isPreviewMode = isPreviewModeFromUrl();

        // Load user profile
        const profile = await NexusCore.getUserProfile(viewingUserId);

        if (!profile) {
          document.querySelector('.profile-view-container').innerHTML = `
            <div class="empty-state">
              <p style="font-size: 1.2rem; color: var(--accent-color);">Profile not found</p>
            </div>
          `;
          return;
        }

        // Update banner based on whether viewing own profile or another user's
        updateBanner(profile);

        // Display profile name and username
        const displayName = profile.display_name || profile.email?.split('@')[0] || 'Anonymous';
        document.getElementById('profileName').textContent = displayName;
        document.getElementById('profileUsername').textContent = profile.username ? `@${profile.username}` : '';

        // Display avatar
        const avatarEl = document.getElementById('profileAvatar');
        if (profile.profile_photo_url) {
          avatarEl.innerHTML = `<img src="${NexusCore.escapeHtml(profile.profile_photo_url)}" alt="Profile photo">`;
        } else {
          avatarEl.textContent = displayName.charAt(0).toUpperCase();
        }

        // Display bio
        if (profile.bio) {
          document.getElementById('profileBio').textContent = profile.bio;
        }

        // Display meta information
        const metaContainer = document.getElementById('profileMeta');
        const metaItems = [];

        // Gender (if show_gender is true and gender exists)
        if (profile.show_gender !== false && profile.gender && profile.gender !== 'prefer_not_to_say') {
          const genderIcons = {
            'female': '‚ôÄÔ∏è',
            'male': '‚ôÇÔ∏è',
            'non-binary': '‚ößÔ∏è',
            'other': 'üè≥Ô∏è'
          };
          const genderLabels = {
            'female': 'Female',
            'male': 'Male',
            'non-binary': 'Non-binary',
            'other': 'Other'
          };
          const genderIcon = genderIcons[profile.gender] || '';
          const genderLabel = genderLabels[profile.gender] || profile.gender;
          metaItems.push(`<div class="meta-item"><span class="gender-badge">${genderIcon} ${genderLabel}</span></div>`);
        }

        // Age (if show_age is true and birth_date exists)
        if (profile.show_age && profile.birth_date) {
          const age = calculateAge(profile.birth_date);
          if (age) {
            metaItems.push(`<div class="meta-item">üéÇ ${age} years old</div>`);
          }
        }

        // Profile visibility
        const visibilityIcons = {
          'public': 'üåç',
          'connections_only': 'üîó',
          'private': 'üîí'
        };
        const visibilityLabels = {
          'public': 'Public',
          'connections_only': 'Connections Only',
          'private': 'Private'
        };
        const visibilityIcon = visibilityIcons[profile.profile_visibility] || 'üëÅÔ∏è';
        const visibilityLabel = visibilityLabels[profile.profile_visibility] || 'Unknown';
        metaItems.push(`<div class="meta-item">${visibilityIcon} ${visibilityLabel}</div>`);

        // Display AI feed URL if set (shows this is a real posting AI)
        if (profile.feed_url) {
          metaItems.push(`<div class="meta-item"><a href="${NexusCore.escapeHtml(profile.feed_url)}" target="_blank" style="color: var(--accent-color); text-decoration: none;">üì° AI Feed</a></div>`);
        }

        metaContainer.innerHTML = metaItems.join('');

        // Load and display tags (tags are the only profile data displayed)
        await loadUserTags();

        // Display additional photos
        if (profile.additional_photos && profile.additional_photos.length > 0) {
          const photoGallery = document.getElementById('photoGallery');
          photoGallery.innerHTML = profile.additional_photos.map(url => `
            <div class="photo-item">
              <img src="${NexusCore.escapeHtml(url)}" alt="Profile photo" loading="lazy">
            </div>
          `).join('');
          document.getElementById('photosSection').style.display = 'block';
        }

      } catch (error) {
        console.error('Error loading profile:', error);
        document.querySelector('.profile-view-container').innerHTML = `
          <div class="empty-state">
            <p style="font-size: 1.2rem; color: var(--accent-color);">Error loading profile</p>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Show comparison panel for interest/experience levels
    function showComparisonPanel(viewedTags, matchingTags, myTagsByName) {
      const comparisonSection = document.getElementById('comparisonSection');
      const interestContent = document.getElementById('interestComparisonContent');
      const experienceContent = document.getElementById('experienceComparisonContent');

      // Calculate match percentage
      const totalUniqueTags = new Set([
        ...viewedTags.map(t => t.tag_name?.toLowerCase()),
        ...currentUserTags.map(t => t.tag_name?.toLowerCase())
      ]).size;
      const matchPercentage = totalUniqueTags > 0 ? Math.round((matchingTags.length / totalUniqueTags) * 100) : 0;

      document.getElementById('matchPercentage').textContent = `${matchPercentage}%`;
      document.getElementById('matchCount').textContent = `${matchingTags.length} matching tag${matchingTags.length !== 1 ? 's' : ''} out of ${viewedTags.length}`;

      // Build interest level comparisons for matching tags
      const interestComparisons = matchingTags
        .filter(t => t.interest_level && myTagsByName[t.tag_name?.toLowerCase()]?.interest_level)
        .map(theirTag => {
          const myTag = myTagsByName[theirTag.tag_name?.toLowerCase()];
          return {
            name: theirTag.tag_name,
            myLevel: myTag.interest_level || 3,
            theirLevel: theirTag.interest_level || 3
          };
        });

      // Build experience level comparisons for matching tags
      const experienceComparisons = matchingTags
        .filter(t => t.experience_level && myTagsByName[t.tag_name?.toLowerCase()]?.experience_level)
        .map(theirTag => {
          const myTag = myTagsByName[theirTag.tag_name?.toLowerCase()];
          return {
            name: theirTag.tag_name,
            myLevel: myTag.experience_level || 3,
            theirLevel: theirTag.experience_level || 3
          };
        });

      // Render interest comparisons
      if (interestComparisons.length > 0) {
        interestContent.innerHTML = interestComparisons.map(comp => `
          <div class="comparison-stat">
            <span style="min-width: 120px; font-size: 0.85rem;">${NexusCore.escapeHtml(comp.name)}</span>
            <div class="comparison-bar">
              <div class="comparison-bar-fill you" style="width: ${comp.myLevel * 20}%; opacity: 0.7;"></div>
              <div class="comparison-bar-fill them" style="width: ${comp.theirLevel * 20}%; opacity: 0.5;"></div>
            </div>
            <span style="font-size: 0.75rem; min-width: 60px; text-align: right;">${comp.myLevel} / ${comp.theirLevel}</span>
          </div>
        `).join('');
        document.getElementById('interestComparison').style.display = 'block';
      } else {
        document.getElementById('interestComparison').style.display = 'none';
      }

      // Render experience comparisons
      if (experienceComparisons.length > 0) {
        experienceContent.innerHTML = experienceComparisons.map(comp => `
          <div class="comparison-stat">
            <span style="min-width: 120px; font-size: 0.85rem;">${NexusCore.escapeHtml(comp.name)}</span>
            <div class="comparison-bar">
              <div class="comparison-bar-fill you" style="width: ${comp.myLevel * 20}%; opacity: 0.7;"></div>
              <div class="comparison-bar-fill them" style="width: ${comp.theirLevel * 20}%; opacity: 0.5;"></div>
            </div>
            <span style="font-size: 0.75rem; min-width: 60px; text-align: right;">${comp.myLevel} / ${comp.theirLevel}</span>
          </div>
        `).join('');
        document.getElementById('experienceComparison').style.display = 'block';
      } else {
        document.getElementById('experienceComparison').style.display = 'none';
      }

      // Show the section if we have any matches
      if (matchingTags.length > 0) {
        comparisonSection.style.display = 'block';
      }
    }

    // Load user tags with comparison
    async function loadUserTags() {
      try {
        const viewedTags = await NexusCore.getUserTags(viewingUserId);
        const tagsDisplay = document.getElementById('tagsDisplay');

        // Compare as strings to avoid type mismatch issues
        const isOwnProfile = currentUserId && String(currentUserId) === String(viewingUserId);

        // Load current user's tags for comparison (only if viewing someone else AND logged in)
        if (currentUserId && !isOwnProfile && !isPreviewMode) {
          currentUserTags = await NexusCore.getUserTags(currentUserId);
        } else {
          // Ensure currentUserTags is empty for own profile
          currentUserTags = [];
        }

        if (viewedTags.length === 0) {
          tagsDisplay.innerHTML = '<div class="empty-state">No tags selected yet</div>';
          return;
        }

        // Create a map of current user's tag names for quick lookup
        const myTagNames = new Set(currentUserTags.map(t => t.tag_name?.toLowerCase()));
        const myTagsByName = {};
        currentUserTags.forEach(t => {
          if (t.tag_name) myTagsByName[t.tag_name.toLowerCase()] = t;
        });

        // Sort tags by display order
        viewedTags.sort((a, b) => {
          if (a.display_order !== b.display_order) {
            return a.display_order - b.display_order;
          }
          return (a.tag_name || '').localeCompare(b.tag_name || '');
        });

        // Find matching tags
        const matchingTags = viewedTags.filter(t => myTagNames.has(t.tag_name?.toLowerCase()));
        const matchCount = matchingTags.length;

        // Render tags with matching highlights
        tagsDisplay.innerHTML = viewedTags.map(tag => {
          const isMatching = myTagNames.has(tag.tag_name?.toLowerCase());
          return `
            <div class="tag ${isMatching ? 'matching' : ''}" title="${NexusCore.escapeHtml(tag.definition || tag.tag_name)}${isMatching ? ' (You share this tag!)' : ''}">
              ${NexusCore.escapeHtml(tag.tag_name)}
              <span class="tag-version">v${tag.version}</span>
              ${tag.intensity ? getIntensityIndicator(tag.intensity) : ''}
            </div>
          `;
        }).join('');

        // Show comparison panel if viewing another user and have matching tags
        if (!isOwnProfile && !isPreviewMode && currentUserTags.length > 0) {
          showComparisonPanel(viewedTags, matchingTags, myTagsByName);
        }

      } catch (error) {
        console.error('Error loading tags:', error);
        document.getElementById('tagsDisplay').innerHTML = `
          <div class="empty-state" style="color: var(--accent-color);">Error loading tags</div>
        `;
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadProfile);
  </script>
  <!-- Age Verification & Cookie Consent -->
  <script src="/js/age-gate.js"></script>
  <script src="/js/cookie-consent.js"></script>
</body>
</html>
